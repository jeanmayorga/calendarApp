<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="app.css" />
    <title>Wefere Calendar</title>
</head>
<body>
  <div class="App">
    <div class="loadingContainer" id="loading">
      <div class="d-flex justify-content-center">
        <div class="spinner-border text-success" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>
    </div>
    <img src="wefere.jpg" />
    <h1>Wefere Calendar</h1>
    <form id="intro">
        <div class="row">
          <div class="col">
            <label for="entrada">Horario de Entrada</label>
            <select class="form-control" id="entrada">
                <option>06:00</option>
                <option>07:00</option>
                <option>08:00</option>
                <option>09:00</option>
                <option>10:00</option>
                <option>11:00</option>
                <option>12:00</option>
                <option>13:00</option>
                <option>14:00</option>
                <option>15:00</option>
                <option>16:00</option>
                <option>17:00</option>
                <option>18:00</option>
                <option>19:00</option>
                <option>20:00</option>
            </select>
          </div>
          <div class="col">
            <label for="entrada">Horario de Salida</label>
            <select class="form-control" id="salida">
                <option>06:00</option>
                <option>07:00</option>
                <option>08:00</option>
                <option>09:00</option>
                <option>10:00</option>
                <option>11:00</option>
                <option>12:00</option>
                <option>13:00</option>
                <option>14:00</option>
                <option>15:00</option>
                <option>16:00</option>
                <option>17:00</option>
                <option>18:00</option>
                <option>19:00</option>
                <option>20:00</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div id="authorize_button" class="btn btn-outline-success btn-block acceder">Autorizar mi Calendario</div>
        </div>
      </form>
      <div id="appCalendar">
        <p id="logText"></p>
        <div id="content"></div>
        <button id="signout_button" class="btn btn-outline-danger btn-block">Salir</button>
      </div>
  </div>
    <script type="text/javascript">
      const CLIENT_ID = '105214770235-aa3s14n7a0mb56e81ln30i27aub2l98c.apps.googleusercontent.com';
      const API_KEY = 'AIzaSyD8KCLI0BKpR6YdQECx14LJNRXwF2U6otk';
      var DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest"];
      var SCOPES = "https://www.googleapis.com/auth/calendar.readonly";

      var authorizeButton = document.getElementById('authorize_button');
      var signoutButton = document.getElementById('signout_button');

      var intro = document.getElementById('intro');
      var appCalendar = document.getElementById('appCalendar');
      var logText = document.getElementById('logText');
      var loading = document.getElementById('loading');

      function handleClientLoad() {
        gapi.load('client:auth2', initClient)
      }
      function initClient() {
        loading.style.display = 'block'
        gapi.client.init({
          apiKey: API_KEY,
          clientId: CLIENT_ID,
          discoveryDocs: DISCOVERY_DOCS,
          scope: SCOPES
        }).then(function () {

          gapi.auth2.getAuthInstance().isSignedIn.listen(updateSigninStatus);
          updateSigninStatus(gapi.auth2.getAuthInstance().isSignedIn.get());

          authorizeButton.addEventListener("click", () => {
            gapi.auth2.getAuthInstance().signIn();
          })
          signoutButton.addEventListener("click", () => {
            gapi.auth2.getAuthInstance().signOut();
            document.getElementById("content").innerHTML = "";
          })

        }, function(error) {
          console.log(error)
        });
      }
      function updateSigninStatus(isSignedIn) {
        if (isSignedIn) {
          appCalendar.style.display = 'block';
          intro.style.display = 'none';
          listUpcomingEvents();
        } else {
          appCalendar.style.display = 'none';
          intro.style.display = 'block';
        }
        loading.style.display = 'none'
      }
      function appendPre(event) {
        const content = document.getElementById('content')
        const card = `
        <div class="card event" style="width: 100%;">
          <div class="card-body">
            <h5 class="card-title">${event.summary}</h5>
            <div class="row">
              <div class="col-sm">
                <h6 class="card-subtitle mb-2 text-muted">Empieza :</h6>
                <p> ${event.start.dateTime}</p>
              </div>
              <div class="col-sm">
                <h6 class="card-subtitle mb-2 text-muted">Empieza :</h6>
                <p>${event.end.dateTime}</p>
              </div>
              </div>
          </div>
          <div class="card-footer text-muted">
            Creado por: ${event.creator.email}
          </div>
        </div>
        `
        content.insertAdjacentHTML('beforeend', card);
      }
      function listUpcomingEvents() {
        gapi.client.calendar.events.list({
          'calendarId': 'primary',
          'timeMin': (new Date()).toISOString(),
          'showDeleted': false,
          'singleEvents': true,
          'maxResults': 10,
          'orderBy': 'startTime'
        }).then(function(response) {
          var events = response.result.items;
          console.log(events)
          logText.innerHTML = "Eventos de google Calendar con las horas restringidas";
          if (events.length > 0) {
            events.forEach(event => {
              var when = event.start.dateTime;
              if (!when) {when = event.start.date;}
              appendPre(event)
            });
          } else {
            logText.innerHTML = "No tienes eventos.";
          }
        });
      }

    </script>

  <script async defer src="https://apis.google.com/js/api.js"
  onload="this.onload=function(){};handleClientLoad()"
  onreadystatechange="if (this.readyState === 'complete') this.onload()">
  </script>
  </body>
</html>